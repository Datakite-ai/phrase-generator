<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Training Phrase Generator</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
      :root {
        --primary-color: #4f46e5;
        --primary-hover: #4338ca;
        --bg-color: #f3f4f6;
        --card-bg: #ffffff;
        --text-color: #1f2937;
        --border-radius: 12px;
      }

      body {
        font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
      }

      .container {
        background-color: var(--card-bg);
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1),
          0 8px 10px -6px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 600px;
        text-align: center;
      }

      h1 {
        margin-bottom: 1.5rem;
        font-size: 1.8rem;
        color: #111827;
      }

      .input-group {
        margin-bottom: 1.5rem;
        text-align: left;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #374151;
      }

      textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        resize: vertical;
        min-height: 120px;
        box-sizing: border-box;
        transition: border-color 0.2s;
      }

      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        width: 100%;
      }

      button:hover {
        background-color: var(--primary-hover);
      }

      button:active {
        transform: translateY(1px);
      }

      button:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
      }

      #status {
        margin-top: 1rem;
        min-height: 1.5rem;
        font-weight: 500;
      }

      .success {
        color: #059669;
      }
      .error {
        color: #dc2626;
      }
      .loading {
        color: #4b5563;
      }

      .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
        vertical-align: middle;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Training Phrase Generator</h1>

      <div class="input-group">
        <label for="intentDescription">Intent Description</label>
        <textarea
          id="intentDescription"
          placeholder="e.g., I want to reset my password because I forgot it..."
        ></textarea>
      </div>

      <button id="generateBtn" onclick="generatePhrases()">
        Generate & Download Excel
      </button>

      <div id="status"></div>
    </div>

    <script>
      const API_KEY = "AIzaSyAFcQdFF8y858s9nkn_iCy8JWsKcyU0NS0";
      const API_URL =
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

      async function generatePhrases() {
        const description = document
          .getElementById("intentDescription")
          .value.trim();
        const statusDiv = document.getElementById("status");
        const btn = document.getElementById("generateBtn");

        if (!description) {
          statusDiv.textContent = "Please enter an intent description.";
          statusDiv.className = "error";
          return;
        }

        // UI Loading State
        btn.disabled = true;
        statusDiv.innerHTML =
          '<span class="spinner"></span>Generating content...';
        statusDiv.className = "loading";

        const prompt = `
              You are an expert NLU training data generator.
              I will provide an intent description. You must generate training data for this intent.

              Requirements:
              1. Generate 20 training phrases in Arabic (Modern Standard Arabic or common dialects).
              2. Generate 20 training phrases in English.
              3. Generate 20 keywords in Arabic (single words or short compounds relevant to the intent).
              4. Generate 20 keywords in English.
              5. Output MUST be valid JSON only, with no markdown formatting or backticks.
              6. The JSON structure must be:
              {
                  "arabic_phrases": ["..."],
                  "english_phrases": ["..."],
                  "arabic_keywords": ["..."],
                  "english_keywords": ["..."]
              }

              Intent Description: "${description}"

              Examples of high-quality training phrases (for style reference):
              - "عرض حساباتي كلها"
              - "Show all my accounts"
              - "تحويل بين حساباتي مبلغ 200 ريال"
              - "Transfer 500 USD between my accounts"
              - "اقدر اطلع بطاقة مدى لحسابي الجاري؟"
              - "Can I get a debit card for my current account?"
              - "أبغى كشف حساب إلكتروني"
              - "I need an e-statement for my account"
              - "كم عموله التحويل الدولي؟"
              - "What's the fee for an international transfer?"
          `;

        try {
          const response = await fetch(`${API_URL}?key=${API_KEY}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: prompt,
                    },
                  ],
                },
              ],
            }),
          });

          if (!response.ok) {
            throw new Error(
              `API Error: ${response.status} ${response.statusText}`
            );
          }

          const data = await response.json();
          const generatedText = data.candidates[0].content.parts[0].text;

          // Clean up potential markdown code blocks
          const cleanJson = generatedText
            .replace(/```json/g, "")
            .replace(/```/g, "")
            .trim();
          const parsedData = JSON.parse(cleanJson);

          if (
            !parsedData.arabic_phrases ||
            !parsedData.english_phrases ||
            !parsedData.arabic_keywords ||
            !parsedData.english_keywords
          ) {
            throw new Error("Invalid response format from AI");
          }

          // Generate a safe filename prefix from the intent description (first 3-4 words)
          const intentName = description
            .split(/\s+/)
            .slice(0, 4)
            .join("_")
            .replace(/[^a-zA-Z0-9_\u0600-\u06FF]/g, "");

          // Export 4 files
          exportToExcel(
            parsedData.arabic_phrases,
            "training_phrase",
            "ar",
            intentName
          );

          setTimeout(
            () =>
              exportToExcel(
                parsedData.english_phrases,
                "training_phrase",
                "en",
                intentName
              ),
            500
          );
          setTimeout(
            () =>
              exportToExcel(
                parsedData.arabic_keywords,
                "keyword",
                "ar",
                intentName
              ),
            1000
          );
          setTimeout(
            () =>
              exportToExcel(
                parsedData.english_keywords,
                "keyword",
                "en",
                intentName
              ),
            1500
          );

          statusDiv.textContent = "Success! Downloading 4 Excel files...";
          statusDiv.className = "success";
        } catch (error) {
          console.error(error);
          statusDiv.textContent = `Error: ${error.message}`;
          statusDiv.className = "error";
        } finally {
          btn.disabled = false;
        }
      }

      function exportToExcel(dataList, type, lang, intentName) {
        let wsData = [];

        if (type === "training_phrase") {
          // Schema: KeywordId (empty), Phrase
          wsData.push(["KeywordId", "Phrase"]);
          dataList.forEach((item) => wsData.push(["", item]));
        } else {
          // Schema: Keyword
          wsData.push(["Keyword"]);
          dataList.forEach((item) => wsData.push([item]));
        }

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Data");

        // Filename: intentName - type - lang - timestamp
        const now = new Date();
        const timestamp = now.toISOString().replace(/[:.]/g, "-").slice(0, 19);
        const filename = `${intentName}_${type}_${lang}_${timestamp}.xlsx`;

        XLSX.writeFile(wb, filename);
      }
    </script>
  </body>
</html>
